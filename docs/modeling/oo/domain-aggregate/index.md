# 聚合

聚合是面向对象领域模型中和技术实现关系最紧密的一类对象。领域模型建模到得到聚合，才能够被代码实现。

## 聚合是什么？是对象的集合吗？

聚合是 DDD 里的术语，指一些对象，他们在一起完成一组高耦合的功能，总是被一起载入内存一起持久化。和面向对象程序设计说的聚合的概念并不是一回事，不是简单的对象的集合。

## 如何理解聚合是由其功能定义？聚合内的属性服务于其功能？

在建模的过程中，当我们找到了一些高耦合高内聚的功能，这些功能经常跨越时间，我们需要一种能跨越时间存在的对象来实现这些功能，那么这个对象就是聚合了。可见聚合对象存在的意义正是为了实现那些功能，有什么样的功能，就有什么样的聚合对象。聚合对象内持有的数据是完全服务于聚合的功能的。功能不需要的数据，是没有必要硬塞到聚合里的。我们也不期望外部直接使用聚合内部的数据，只希望外部使用聚合的功能。

## 聚合根是什么？聚合可以没有聚合根吗？

聚合根是聚合和外部交互的入口，也是一个对象。外部只能通过访问聚合根来访问聚合内的功能。不允许外部直接访问聚合的内部。如果外部要引用聚合，也只能引用聚合的根，而不是直接引用聚合内部的对象。这样，聚合根成为了整个聚合的代表，隐藏了聚合内部的实现，简化了外部使用聚合的难度，收拢对聚合内部的访问从而更容易实现一些功能。

聚合必须得有聚合根。如果聚合只有一个对象，那这个对象自己就是聚合根。聚合和聚合根是一一映射的关系。

## 聚合 Id 和聚合根 ID 是什么关系？

聚合 ID 就是聚合根的 ID。设计出聚合根就设计出了聚合；要设计聚合，就得设计聚合根。聚合根的 ID，就是聚合的 ID。

## 聚合所承担的功能要高内聚高耦合是什么意思？

这要求这些功能间存在比较强的依赖关系，不太容易被分割开来，这些功能对聚合外则没有或者只有较低的依赖关系。功能间的依赖关系体现为，函数间的互相调用，共享聚合内的数据等。实际上，这和单一职责的要求是一样的。

反过来，如果一个聚合内存在一些功能和另外一些功能间没有什么关系，那么就可以考虑是否应该分拆为两个聚合了。

## 聚合和实体是一个概念？

一般情况下聚合根是一个实体。但是并不是每个实体都是聚合根，都是独立存在的聚合，它可能只是聚合内的一个实体，是聚合的一部分。

## 有没有可能某个聚合就是没有功能，只是一些数据呢？

有可能。但是换个角度说，这个聚合也是有功能的，它的功能就是持有和管理一些数据。现实中，那些号称只要单纯 CRUD 就可以的简单的聚合，往往最终都不会那么简单。如果只是数据维护，那何必做软件系统呢？直接用在线数据表格不就行了？直接用 sql 客户端连接关系型数据库不就行了？

## 聚合是不是就是数据库的表？

不是。在 DDD 的方法论中，我们先设计出聚合，之后再去设计数据库的表，数据库的表用来存储聚合的数据。实际上，设计表的时候也不要求数据库表和聚合对齐，有可能多个聚合共用同一张表，也有可能一个聚合的数据被存放到多张表内。对于长期维护的复杂系统，有时候这种不对应是常态，毕竟相对于领域模型，数据库模型更难以变更。

## 聚合内的数据必须强一致？

是的。每一次对一个聚合进行操作，聚合内部的状态必然是一致的，不存在被修改一半的情况。这一般也意味着我们总是要串行地使用聚合的功能。

## 为什么没有用 status 字段表示状态？

聚合内持有的数据是为了聚合的功能服务的。只要聚合的功能能够被实现，即使没有一个叫做“状态”的字段，也没有问题。并不是所有的聚合，都必须有一个状态字段。有的时候，表示状态机的字段也不一定非得叫“状态”。状态机确实是一种很有用的软件设计武器，但并不是所有情况下都要用它。如果要实现某个聚合的功能，用状态机比较容易，那么为这个聚合设计“状态”字段，就是很合情合理的。

## 聚合是一个状态机吗？必须给聚合画状态图吗？

从状态变化的角度看，很多聚合确实是一个状态机。状态机是聚合的一个表象，是服务于其功能的，不是它内在的本质。没有人为了状态机去设计一个聚合，反过来是为了更容易完成功能，而给聚合设计一个状态机。

不一定必须给聚合画状态图，毕竟有很多聚合的状态转化太简单了，没有必要画。比如，有些聚合就只有启用禁用两个状态切换，如此简单就没有必要画状态图了。

## 一个聚合可以持有另外一个聚合的引用吗？

不可以。但是一个聚合可以持有另外一个聚合的 id，从而在需要的时候通过 id 去获取别的聚合的引用。如果一个聚合持有了别的聚合的引用，那么当载入这个聚合的时候，就要把被持有的聚合也载入内存。这种方式会导致聚合间的边界模糊，容易形成庞大的对象网络，导致最终难以维护。

## 一个聚合可以依赖另外一个聚合的功能吗？

当然可以。聚合就是普通的对象，一个对象依赖另外一个对象的功能是很正常的设计。

## 我有一些有状态的功能，是全局唯一的，也可以设计成聚合吗？

可以。这种情况，相当于这个聚合只有一个实例。由于只有一个实例，就没有必要显式的指定 id 了。

举个场景，有一个全局下单限制的功能，管理员可以在后台配置一些参数，启用禁用一些规则，调整一些规则的参数。当用户下单的时候，要对这个订单进行校验，看是否要被限制下单。这个限制的功能是全局的，不针对某个一人某一个商品等。当我们要使用这个聚合的时候，只要载入这个唯一的下单限制聚合实例，然后调用它的检查是否限制下单的功能就可以了。
